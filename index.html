<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üìç Location Tracker</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8f9fa;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .tracker-card {
      max-width: 500px;
      width: 100%;
      padding: 30px;
      background: #ffffff;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    }

    .status-badge {
      font-size: 0.95em;
      padding: 10px;
      margin-top: 10px;
    }

    .last-location {
      font-size: 0.95em;
      background: #f1f3f5;
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      line-height: 1.5;
      cursor: pointer;
    }

    .icon {
      font-size: 1.5em;
      vertical-align: middle;
    }

    .fade-in {
      animation: fadeIn 0.6s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #map {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 100vw;
      z-index: 9999;
    }

    #closeMap {
      display: none;
      position: fixed;
      top: 15px;
      right: 20px;
      z-index: 10000;
      background: #ffffffcc;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      border: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

  <div class="tracker-card text-center fade-in">
    <h2 class="mb-3"><i class="fas fa-map-marker-alt text-primary icon"></i> Location Tracker</h2>
    <div id="status" class="alert alert-secondary status-badge">Requesting location...</div>
    <div id="lastLocation" class="last-location text-start">
      <i class="fas fa-map-pin text-primary"></i> Tap to view map...
    </div>
  </div>

  <!-- Fullscreen Map -->
  <div id="map"></div>
  <button id="closeMap">Close Map</button>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Load Google Maps API (Modern Loader) -->
  <script>
    (g => {
      var h, a, k,
        p = "The Google Maps JavaScript API",
        c = "google",
        l = "importLibrary",
        q = "__ib__",
        m = document,
        b = window;
      b = b[c] || (b[c] = {});
      var d = b.maps || (b.maps = {}),
        r = new Set(),
        e = new URLSearchParams(),
        u = () => h || (h = new Promise(async (f, n) => {
          await (a = m.createElement("script"));
          e.set("libraries", [...r] + "");
          for (k in g)
            e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]);
          e.set("callback", c + ".maps." + q);
          a.src = `https://maps.${c}apis.com/maps/api/js?` + e;
          d[q] = f;
          a.onerror = () => h = n(Error(p + " could not load."));
          a.nonce = m.querySelector("script[nonce]")?.nonce || "";
          m.head.append(a);
        }));
      d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n));
    })({
      key: "AIzaSyBuePR9-OAGUCvlt4w0y9XERmv6_JWbe3U",
      v: "weekly",
    });
  </script>

  <!-- App Script -->
  <script>
    let currentLat = null;
    let currentLon = null;
    let map, marker;

    async function initMap(lat, lon) {
      const { Map } = await google.maps.importLibrary("maps");
      const { Marker } = await google.maps.importLibrary("marker");

      map = new Map(document.getElementById("map"), {
        center: { lat, lng: lon },
        zoom: 16,
      });

      marker = new Marker({
        position: { lat, lng: lon },
        map,
        title: "Your Current Location"
      });
    }

    function sendLocationToServer(lat, lon) {
      fetch("http://localhost:5000/location", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          device_id: "browser-001",
          latitude: lat,
          longitude: lon,
          timestamp: new Date().toISOString()
        })
      })
      .then(res => res.json())
      .then(data => {
        const statusEl = document.getElementById("status");
        const lastEl = document.getElementById("lastLocation");

        if (data.status === "success") {
          statusEl.className = "alert alert-success status-badge";
          statusEl.innerHTML = `<i class="fas fa-check-circle"></i> Location saved to server.`;
        } else if (data.status === "ignored") {
          statusEl.className = "alert alert-warning status-badge";
          statusEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> Location unchanged. Not saved.`;
        }

        lastEl.innerHTML = `
          <strong>Last Location (click to view map):</strong><br>
          <i class="fas fa-map-pin text-danger"></i> Latitude: ${lat}<br>
          <i class="fas fa-map-pin text-primary"></i> Longitude: ${lon}
        `;

        currentLat = lat;
        currentLon = lon;
      })
      .catch(err => {
        const statusEl = document.getElementById("status");
        statusEl.className = "alert alert-danger status-badge";
        statusEl.innerHTML = `<i class="fas fa-times-circle"></i> Failed to send location.`;
        console.error("Error:", err);
      });
    }

    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          sendLocationToServer(lat, lon);
        },
        () => {
          document.getElementById("status").className = "alert alert-danger status-badge";
          document.getElementById("status").innerHTML = `<i class="fas fa-ban"></i> Location access denied.`;
        }
      );
    } else {
      document.getElementById("status").className = "alert alert-danger status-badge";
      document.getElementById("status").innerHTML = `<i class="fas fa-exclamation-triangle"></i> Geolocation not supported.`;
    }

    document.getElementById("lastLocation").addEventListener("click", () => {
      if (currentLat && currentLon) {
        document.getElementById("map").style.display = "block";
        document.getElementById("closeMap").style.display = "block";
        initMap(currentLat, currentLon);
      }
    });

    document.getElementById("closeMap").addEventListener("click", () => {
      document.getElementById("map").style.display = "none";
      document.getElementById("closeMap").style.display = "none";
    });
  </script>
</body>
</html>
